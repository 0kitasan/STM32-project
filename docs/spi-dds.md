## 位移寄存器（Shift Register）

位移操作：用于传输数据流

**常用位移寄存器：74HC595**

- DS (SER): 串行数据输入引脚
- SHCP (SRCLK): 移位寄存器时钟引脚
- STCP (RCLK): 存储寄存器时钟引脚
- MR (Master Reset): 主复位引脚（低电平有效）
- OE (Output Enable): 输出使能引脚（低电平有效）

可实现流水灯(ws2812)

### SHCP (Shift Register Clock Pin)

SHCP 控制移位寄存器中的数据移位。当 SHCP 引脚从低电平变为高电平时，移位寄存器中的数据会向右移动一位，同时将 DS 引脚上的数据输入到移位寄存器的最低位（Q0）。

### STCP (Storage Register Clock Pin)

STCP 控制存储寄存器中的数据更新。当 STCP 引脚从低电平变为高电平时，移位寄存器中的数据会被复制到存储寄存器中，并更新 Q0-Q7 引脚上的并行输出。

## SPI（Serial Peripheral Interface）

SPI（Serial Peripheral Interface，**串行外设接口**）是一种**同步串行通信协议**，广泛用于微控制器与各种外围设备（如传感器、SD 卡、显示屏等）之间的高速数据传输。SPI 具有全双工通信能力，支持**主从模式**，通信效率高且易于实现。

### SPI 基本原理

SPI 通信涉及四根主要信号线：

1. **MOSI（Master Out Slave In）** ：主设备输出数据，供从设备接收。
2. **MISO（Master In Slave Out）** ：从设备输出数据，供主设备接收。
3. **SCK（Serial Clock）** ：串行时钟信号，由主设备生成，控制数据传输速率。
4. **SS（Slave Select）或 CS（Chip Select）** ：从设备选择信号，低电平有效，由主设备控制，用于选择具体的从设备进行通信（即片选，或从片选)。

### 工作模式

SPI 有四种工作模式，主要由时钟极性（CPOL）和时钟相位（CPHA）决定：

* **CPOL（Clock Polarity）** ：控制时钟信号的空闲状态。
  * CPOL = 0 时，空闲状态下时钟信号为低电平。
  * CPOL = 1 时，空闲状态下时钟信号为高电平。
* **CPHA（Clock Phase）** ：控制数据在时钟的哪个边沿采样。
  * CPHA = 0 时，数据在第一个时钟边沿（上升沿或下降沿）采样。
  * CPHA = 1 时，数据在第二个时钟边沿（上升沿或下降沿）采样。

### 通信过程

1. **主设备选择从设备** ：主设备将 SS（CS）信号拉低，选择一个从设备进行通信。
2. **数据传输** ：主设备生成时钟信号，通过 MOSI 发送数据，从设备通过 MISO 发送数据。
3. **数据采样** ：根据 CPOL 和 CPHA 的设置，在时钟的相应边沿采样数据。
4. **结束通信** ：主设备将 SS（CS）信号拉高，结束通信。

### 优缺点

 **优点** ：

* 高速通信，支持全双工数据传输。
* 硬件实现简单，占用引脚少。
* 支持多从设备，每个从设备有独立的 SS（CS）信号。

 **缺点** ：

* 需要额外的 SS（CS）引脚来选择从设备，硬件连接复杂度随从设备数量增加而增加。
* 不支持多主设备模式。
* 通信距离有限，通常适用于板级通信。

## DDS

DDS（Direct Digital Synthesis，**直接数字合成**）是一种数字信号处理技术，用于生成任意频率和相位的波形信号。DDS 广泛应用于通信系统、信号发生器、音频合成和测量设备中，因其高频率分辨率、快速频率切换和相位控制精度而备受青睐。

### DDS 的基本原理

DDS 系统的核心组件包括：

- **相位累加器（Phase Accumulator）** ：

  * 用于生成波形的相位信息。相位累加器以固定的步长不断累加相位增量，由输入的频率控制字决定。
  * 相位累加器的输出是一个线性增长的相位值，其值在每个时钟周期增加一个固定的相位增量。
- **波形存储器（Waveform Look-Up Table, LUT）** ：

  * 存储预计算的波形数据，例如正弦波的离散采样值。
  * 相位累加器的输出作为 LUT 的地址，用于查找相应的波形数据。
- **数模转换器（Digital-to-Analog Converter, DAC）** ：

  * 将查找到的波形数据转换为模拟信号输出。
- **频率控制字（Frequency Control Word, FCW）** ：

  * 用于控制相位累加器的相位增量，从而控制输出信号的频率。

### 工作过程

- **相位累加** ：

  * 相位累加器在每个时钟周期累加一个相位增量，该增量由频率控制字（FCW）决定。
  * 累加器的输出是一个逐渐增大的相位值，并在达到最大值后回绕。
- **波形查找** ：

  * 相位累加器的输出作为波形存储器的地址，从 LUT 中查找对应的波形值。
- **信号生成** ：

  * 波形存储器输出的数值被送到 DAC，转换为模拟信号输出。

通过改变频率控制字，可以动态调整输出信号的频率，从而实现频率合成。

### 优缺点

 **优点** ：

* **高频率分辨率** ：由于频率控制字可以是高位宽的二进制数，DDS 的频率分辨率非常高。
* **快速频率切换** ：通过改变频率控制字，DDS 能够迅速切换输出频率。
* **相位控制** ：DDS 能够精确控制输出信号的相位，适用于相位调制应用。
* **频谱纯度** ：与模拟振荡器相比，DDS 的频谱纯度更高，杂散信号更少。

 **缺点** ：

* **有限的输出频率范围** ：受限于时钟频率和相位累加器的位宽，DDS 的输出频率范围有限。
* **杂散分量** ：由于相位截断和数模转换器的非线性，可能会产生杂散分量。
* **硬件复杂性** ：实现高精度和高速的 DDS 需要复杂的硬件设计。

### 应用示例

1. **信号发生器** ：DDS 被广泛用于信号发生器中，生成精确的正弦波、方波、三角波等波形，用于测试和测量设备。
2. **通信系统** ：DDS 用于合成和调制射频信号，应用于无线通信、雷达系统和卫星通信中。
3. **音频合成** ：在音乐合成器中，DDS 用于生成各种音调和音色，实现高精度的音频信号生成。

## DDS实例：AD9834（基于SPI接口）

AD9834 是 Analog Devices 公司出品的一款高性能、低功耗、可编程的直接数字合成（DDS）芯片。它主要用于产生精确的正弦波、三角波和方波信号，广泛应用于信号发生器、调制器、频率合成器等领域。

### 特点

* **频率范围** ：最高输出频率可达 37.5 MHz。
* **低功耗** ：在 2.3 V 至 5.5 V 供电范围内，功耗非常低。
* **分辨率** ：具有 28 位频率分辨率和 12 位相位分辨率。
* **输出波形** ：可编程输出正弦波、三角波和方波。
* **SPI 接口** ：通过串行外设接口（SPI）进行编程和控制。
* **上电复位和睡眠模式** ：支持电源启动复位和低功耗睡眠模式。
* **片内 DAC** ：集成 10 位数模转换器（DAC）。

### 原理

AD9834 的原理通常包括以下几个部分：

1. **相位累加器（Phase Accumulator）** ：用于生成波形的相位信息，28 位累加器提供高分辨率。
2. **波形生成器（Waveform Generator）** ：包括一个正弦波查找表（LUT）和一个三角波生成器。
3. **数模转换器（DAC）** ：集成的 10 位 DAC 将数字波形数据转换为模拟信号。
4. **控制寄存器** ：通过 SPI 接口配置和控制 AD9834 的工作模式和参数。

### 编程

参考手册

| Hex    | Bin                 |
| ------ | ------------------- |
|        | 5432 1098 7654 3210 |
| 0x2100 | 0010 0001 0000 0000 |
| 0x50C7 | 0101 0000 1100 0111 |
| 0x4000 | 0100 0000 0000 0000 |
| 0xC000 | 1100 0000 0000 0000 |
| 0x2000 | 0010 0000 0000 0000 |

#### 0x2100—控制寄存器

* **DB13** 设置为1。这允许在两次连续写入中将一个完整的字加载到频率寄存器中。第一次写入包含14位LSB（最低有效位）。第二次写入包含14位MSB（最高有效位）。
* **DB8(RESET位)** 设置为1。这将内部寄存器重置为0，对应于模拟输出的中间值。

#### 0x50C7—频率寄存器0 LSB

* **DB15** 和 **DB14** 分别设置为0和1，这是频率寄存器0的地址。
* 剩余的14位是数据的14位LSB：
  * 0x10C7 = 01 0000 1100 0111

#### 0x4000—频率寄存器0 MSB

* **DB15** 和 **DB14** 分别设置为0和1，这是频率寄存器0的地址。
* 剩余的14位是数据的14位MSB，在本例中全为0。

#### 0xC000—相位寄存器0

* **DB15**、**DB14** 和 **DB13** 设置为110，**DB12** 设置为don't care（X），这是相位寄存器0的地址。
* 剩余的12位是数据位，在本例中全为0。

#### 0x2000—退出复位

* 在RESET设置为0后，七个MCLK周期后，DAC输出端口将出现信号。

| 位   | 名称     | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ---- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| DB13 | B28      | 需要两次写入操作才能将完整的字写入任一频率寄存器。<br />B28 = 1 允许在两个连续写入中将完整的字写入频率寄存器。<br />第一次写入包含频率字的低14位，第二次写入包含高14位。<br />两个连续写入的前两位相同，确保写入相同的频率寄存器。<br />参见表10获取适当地址。在写入两个字后，频率寄存器写入完成。<br />注意，不能连续写入28位到同一频率寄存器，需在不同频率寄存器间切换。<br />完整的28位写入示例见表11。B28 = 0 时，<br />28位频率寄存器作为两个14位寄存器操作，一个包含高14位，一个包含低14位。<br />可以单独修改高14位或低14位。单次写入到相应的频率地址可以修改高14位或低14位。<br />控制位DB12 (HLB) 指示AD9834修改高14位或低14位。 |
| DB12 | HLB      | 控制位允许用户连续加载频率寄存器的高14位或低14位而忽略其余14位。<br />适用于无需完整28位分辨率的情况。与DB13 (B28) 配合使用。<br />控制位指示加载的14位是转移到高14位还是低14位。<br />DB13 (B28) 必须为0，才能单独修改高14位或低14位。<br />HLB = 1 允许写入到频率寄存器的高14位。HLB = 0 允许写入到频率寄存器的低14位。                                                                                                                                                                                                                                                                                                                 |
| DB11 | FSEL     | FSEL位定义频率寄存器选择。参见表8选择频率寄存器。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| DB10 | PSEL     | PSEL位定义相位寄存器选择。参见表9选择相位寄存器。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| DB9  | PIN/SW   | 选择控制功能的源：软件或硬件。PIN/SW = 1 表示使用控制引脚。<br />PIN/SW = 0 表示使用控制位。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| DB8  | RESET    | RESET = 1 重置内部寄存器为0，对应模拟输出中点。<br />RESET = 0 禁用复位，详见复位功能部分。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| DB7  | SLEEP1   | SLEEP1 = 1 禁用内部时钟，DAC输出保持当前值，NCO不再累积。<br />SLEEP1 = 0 启用时钟，详见睡眠功能部分。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| DB6  | SLEEP12  | SLEEP12 = 1 关闭片上DAC，适用于AD9834输出DAC数据的MSB时。<br />SLEEP12 = 0 启用DAC，详见睡眠功能部分。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| DB5  | OPBITEN  | 该位功能是控制SIGN BIT OUT引脚是否有输出。<br />如果不使用SIGN BIT OUT引脚，该位应保持为0。<br />OPBITEN = 1 启用SIGN BIT OUT引脚。<br />OPBITEN = 0 将SIGN BIT OUT输出缓冲器置于高阻态，因此SIGN BIT OUT引脚无输出。                                                                                                                                                                                                                                                                                                                                                                                                                     |
| DB4  | SIGN/PIB | 该位的功能是控制SIGN BIT OUT引脚的输出内容。<br />SIGN/PIB = 1 时，片上比较器连接到SIGN BIT OUT引脚。<br />通过滤波DAC的正弦输出后，可以将波形应用于比较器以生成方波。参见表17。<br />SIGN/PIB = 0 时，DAC数据的MSB（或MSB/2）连接到SIGN BIT OUT引脚。<br />DIV2位控制输出的是：MSB还是MSB/2。                                                                                                                                                                                                                                                                                                                                            |
| DB3  | DIV2     | DIV2与SIGN/PIB和OPBITEN关联使用。参见表17。<br />DIV2 = 1 数字输出直接传递到SIGN BIT OUT引脚。<br />DIV2 = 0 数字输出/2传递到SIGN BIT OUT引脚。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| DB2  | 保留     | 该位必须始终设为0。(Reserved)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| DB1  | MODE     | 该位功能是控制IOUT引脚/IOUTB引脚的输出。<br />如果控制位OPBITEN = 1，则应将该位设为0。<br />MODE = 1 绕过SIN ROM，从DAC生成三角波输出。<br />MODE = 0 使用SIN ROM 将相位信息转换为幅度信息，<br />从而在输出端产生正弦信号。参见表18。                                                                                                                                                                                                                                                                                                                                                                                                    |
| DB0  | 保留     | 该位必须始终设为0。(Reserved)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |



1

## 补充

### LSB（Least Significant Bit）

* **最低有效位** ：二进制数中最右边的一位。
* **位权值** ：在二进制数中，LSB的位权值是2^0（即1）。
* **作用** ：LSB决定了数的奇偶性。如果LSB是1，该数是奇数；如果LSB是0，该数是偶数。

### MSB（Most Significant Bit）

* **最高有效位** ：二进制数中最左边的一位。
* **位权值** ：在二进制数中，MSB的位权值是2^(n-1)，其中n是位的总数。
* **作用** ：MSB决定了数的符号（在有符号数表示中）。在二进制补码表示中，MSB为1表示负数，为0表示正数或零。
